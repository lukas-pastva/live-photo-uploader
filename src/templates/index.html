<!-- templates/index.html -->
{% extends 'base.html' %}
{% block content %}
<h1>Categories</h1>
<form action="{{ url_for('create_category') }}" method="post" class="mb-4">
    {{ form.hidden_tag() }}
    <div class="form-group">
        {{ form.category_name(class="form-control mb-2", placeholder="New Category") }}
        {{ form.submit(class="btn btn-primary btn-lg btn-block") }}
    </div>
</form>

<!-- jsTree Container -->
<div id="category-tree"></div>

<!-- Confirmation Dialog Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Process categories to create a hierarchical structure
    const categories = {{ categories | tojson }};
    const treeData = [];

    categories.forEach(category => {
        const parts = category.split('-');
        let currentLevel = treeData;

        parts.forEach((part, index) => {
            let existingNode = currentLevel.find(node => node.text === part);
            if (!existingNode) {
                existingNode = {
                    text: part,
                    children: [],
                    state: { opened: false }
                };
                currentLevel.push(existingNode);
            }
            if (index === parts.length - 1) {
                // Add the URL for the leaf node
                existingNode.a_attr = { href: "{{ url_for('category_view', category='') }}" + category };
                delete existingNode.children; // Leaf node doesn't need children
            }
            currentLevel = existingNode.children;
        });
    });

    // Initialize jsTree
    $('#category-tree').jstree({
        'core' : {
            'data' : treeData
        }
    });

    // Handle category selection
    $('#category-tree').on("select_node.jstree", function (e, data) {
        const href = data.node.a_attr.href;
        window.location.href = href;
    });
});
</script>
{% endblock %}
