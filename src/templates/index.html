<!-- templates/index.html -->
{% extends 'base.html' %}
{% block content %}
<div class="row">
    <div class="col-md-4">
        <h2>Categories</h2>
        <!-- Tree Container -->
        <div class="tree-container">
            <div id="category-tree"></div>
        </div>
        <!-- Form to create a new category -->
        <form action="{{ url_for('create_category') }}" method="post" class="mt-3">
            {{ form.hidden_tag() }}
            <div class="form-group">
                {{ form.category_name.label(class="form-label") }}
                {{ form.category_name(class="form-control") }}
            </div>
            <div class="form-group">
                {{ form.submit(class="btn btn-primary") }}
            </div>
        </form>
    </div>
    <!-- Removed the separate list of categories -->
</div>

<!-- Include jQuery first -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

<!-- Initialize Bootstrap Treeview and Handle Delete Actions -->
<script>
$(document).ready(function(){
    // Use the dynamic treeData passed from Flask
    var treeData = {{ treeData|tojson }};
    
    $('#category-tree').treeview({
        data: treeData,
        enableHtml: true, // Enable HTML content in node text
        enableLinks: true,
        showBorder: false,
        expandIcon: 'fas fa-chevron-right',
        collapseIcon: 'fas fa-chevron-down',
        nodeIcon: 'fas fa-folder',
        selectedBackColor: '#007bff',
        selectedColor: '#fff',
        levels: 3, // Adjust based on maximum depth
        onNodeSelected: function(event, node) {
            // Prevent navigation if the delete button was clicked
            if (!$(event.target).hasClass('delete-category-btn')) {
                window.location.href = node.href;
            }
        }
    });
    
    // Handle delete button clicks using event delegation
    $('#category-tree').on('click', '.delete-category-btn', function(e){
        e.stopPropagation(); // Prevent the node selection event
        var category = $(this).data('category');
        if(confirm("Are you sure you want to delete the category '" + category + "'? This action cannot be undone.")){
            var deleteUrl = "{{ url_for('delete_category', category='') }}" + encodeURIComponent(category);
            $.ajax({
                url: deleteUrl,
                type: 'POST',
                data: {},
                success: function(response){
                    if(response.status === 'success'){
                        alert(response.message);
                        // Remove the node from the tree without refreshing
                        location.reload(); // Alternatively, implement node removal dynamically
                    } else {
                        alert("Failed to delete category: " + response.message);
                    }
                },
                error: function(xhr, status, error){
                    alert("An error occurred while deleting the category.");
                }
            });
        }
    });
});
</script>
{% endblock %}
